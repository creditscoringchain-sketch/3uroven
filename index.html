<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkPoint - Power Matrix</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        :root {
            --neon-green: #00ff9d;
            --neon-blue: #00d9ff;
            --gold: #ffd700;
            --bg: #0d0d1a;
            --card: rgba(255, 255, 255, 0.1);
            --border: rgba(255, 255, 255, 0.2);
        }

        body {
            background: var(--bg);
            background-image: radial-gradient(circle at top, #1a1a3a, transparent);
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            margin: 0; padding: 20px;
        }

        .container { max-width: 400px; margin: 0 auto; }

        /* HEADER */
        .header { text-align: center; margin-bottom: 20px; }
        .logo { font-size: 2.2rem; font-weight: 900; color: #fff; text-shadow: 0 0 15px rgba(0,255,157,0.4); }
        .wallet-info { font-size: 0.8rem; background: #000; padding: 10px; border-radius: 50px; border: 1px solid var(--border); margin-top: 10px; display: inline-block; color: var(--gold); }

        /* Кнопки */
        .btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-main { background: var(--neon-green); color: #000; box-shadow: 0 5px 20px rgba(0,255,157,0.3); }
        .btn-tg { background: #0088cc; color: #fff; text-decoration: none; display: block; text-align: center; margin-top: 10px; padding: 12px; border-radius: 12px; font-size: 0.8rem; }

        /* Матрица */
        .matrix { background: var(--card); border: 1px solid var(--border); border-radius: 30px; padding: 20px; margin: 20px 0; }
        .lvl-line { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .dots { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .dot { width: 22px; height: 22px; border-radius: 50%; background: #1a1a2e; border: 1px solid #333; transition: 0.5s; }

        /* Анимации */
        @keyframes glow-g { 0% { box-shadow: 0 0 0 0 rgba(0,255,157,0.5); } 70% { box-shadow: 0 0 0 10px transparent; } }
        @keyframes glow-b { 0% { box-shadow: 0 0 0 0 rgba(0,217,255,0.5); } 70% { box-shadow: 0 0 0 10px transparent; } }
        @keyframes glow-y { 0% { box-shadow: 0 0 0 0 rgba(255,215,0,0.5); } 70% { box-shadow: 0 0 0 10px transparent; } }

        .active-1 { background: var(--neon-green); animation: glow-g 2s infinite; border-color: #fff; }
        .active-2 { background: var(--neon-blue); animation: glow-b 2s infinite; border-color: #fff; }
        .active-3 { background: var(--gold); animation: glow-y 2s infinite; border-radius: 4px; border-color: #fff; }

        .locked { opacity: 0.2; filter: grayscale(1); }

        /* Блоки */
        .box { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; border-radius: 10px; color: #fff; margin: 10px 0; box-sizing: border-box; }

        /* Проверка участника (Tool) */
        .tool-box { border: 1px dashed var(--gold); }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo">SPARKPOINT</div>
        <div id="userAddr" class="wallet-info hidden">...</div>
        <button id="btnConn" class="btn btn-main" style="margin-top:15px" onclick="connect()">Подключить Кошелек</button>
        <a href="https://t.me/spartpoint/32" class="btn-tg">ИНСТРУКЦИЯ</a>
    </div>

    <div class="matrix">
        <div class="lvl-line" style="color:var(--neon-green)"><b>LEVEL 1</b> <span id="l1-count">0/2</span></div>
        <div id="r1" class="dots"></div>

        <div id="h2" class="lvl-line locked" style="color:var(--neon-blue)"><b>LEVEL 2</b> <span id="l2-count">0/6</span></div>
        <div id="r2" class="dots locked"></div>

        <div id="h3" class="lvl-line locked" style="color:var(--gold)"><b>LEVEL 3 (WALLET)</b> <span>★</span></div>
        <div id="r3" class="dots locked"></div>
    </div>

    <div id="regBox" class="box">
        <small>Куратор:</small>
        <input type="text" id="refInput" placeholder="0x...">
        <button class="btn btn-main" onclick="register()">Активировать Матрицу</button>
    </div>

    <div id="linkBox" class="box hidden">
        <small>Твоя ссылка:</small>
        <input type="text" id="refLink" readonly>
        <button id="btnCopy" class="btn btn-main" onclick="copy()">Скопировать</button>
    </div>

    <div id="adminTool" class="box tool-box hidden">
        <small style="color:var(--gold)">ПРОВЕРКА УЧАСТНИКА:</small>
        <input type="text" id="checkAddr" placeholder="Введите адрес">
        <button class="btn" style="background:#444; color:#fff; font-size:0.7rem" onclick="check()">Узнать данные</button>
    </div>
</div>

<script>
    const ADDR = '0x2c4326c0577e8Ef8679B302eAd3603Df8224B7ed';
    const ABI = [
        {"inputs":[{"internalType":"address","name":"_referrer","type":"address"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
        {"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"level","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"partnersCount","type":"uint256"},{"internalType":"uint256","name":"structureCount","type":"uint256"},{"internalType":"uint256","name":"internalBalance","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"}
    ];

    let web3, contract, user;

    function build(id, n) { 
        const e = document.getElementById(id);
        for(let i=0; i<n; i++) e.innerHTML += '<div class="dot"></div>';
    }
    build('r1', 2); build('r2', 6); build('r3', 14);

    async function connect() {
        if(!window.ethereum) return alert("Нужен MetaMask!");
        const accs = await window.ethereum.request({method: 'eth_requestAccounts'});
        user = accs[0];
        web3 = new Web3(window.ethereum);
        contract = new web3.eth.Contract(ABI, ADDR);
        
        document.getElementById('btnConn').classList.add('hidden');
        document.getElementById('userAddr').classList.remove('hidden');
        document.getElementById('userAddr').innerText = user.slice(0,6)+'...'+user.slice(-4);
        
        update();
    }

    async function update() {
        try {
            const data = await contract.methods.users(user).call();
            const admin = await contract.methods.admin().call();

            // Показываем проверку только админу
            if(user.toLowerCase() === admin.toLowerCase()) document.getElementById('adminTool').classList.remove('hidden');

            if(data.exists) {
                document.getElementById('regBox').classList.add('hidden');
                document.getElementById('linkBox').classList.remove('hidden');

                const struct = parseInt(data.structureCount);
                const dots = document.querySelectorAll('.dot');
                
                // Красим кружки
                for(let i=0; i < struct; i++) {
                    if(i < 2) dots[i].classList.add('active-1');
                    else if(i < 8) dots[i].classList.add('active-2');
                    else if(i < 22) dots[i].classList.add('active-3');
                }

                // Открываем уровни
                if(struct >= 2) {
                    document.getElementById('h2').classList.remove('locked');
                    document.getElementById('r2').classList.remove('locked');
                    document.getElementById('l1-count').innerText = "2/2";
                } else { document.getElementById('l1-count').innerText = struct + "/2"; }

                if(struct >= 8) {
                    document.getElementById('h3').classList.remove('locked');
                    document.getElementById('r3').classList.remove('locked');
                    document.getElementById('l2-count').innerText = "6/6";
                } else if(struct > 2) { document.getElementById('l2-count').innerText = (struct-2) + "/6"; }

                // Ссылка
                const l = document.getElementById('refLink');
                if(parseInt(data.partnersCount) >= 2) {
                    l.value = "ЛИМИТ (2/2) ЗАПОЛНЕН";
                    document.getElementById('btnCopy').disabled = true;
                } else {
                    l.value = window.location.origin + window.location.pathname + "?ref=" + user;
                }
            }
        } catch(e) { console.error(e); }
    }

    async function check() {
        const addr = document.getElementById('checkAddr').value;
        if(!addr) return;
        const d = await contract.methods.users(addr).call();
        alert(`Участник: ${addr}\nУровень: ${d.level}\nЛичников: ${d.partnersCount}\nВ структуре: ${d.structureCount}\nБаланс: ${web3.utils.fromWei(d.internalBalance, 'ether')} BNB`);
    }

    async function register() {
        const r = document.getElementById('refInput').value || '0x0000000000000000000000000000000000000000';
        await contract.methods.register(r).send({from: user, value: web3.utils.toWei('0.001', 'ether')});
        location.reload();
    }

    function copy() {
        const t = document.getElementById("refLink");
        t.select(); navigator.clipboard.writeText(t.value);
        alert("Ссылка скопирована!");
    }

    window.onload = () => {
        const p = new URLSearchParams(window.location.search);
        if(p.has('ref')) document.getElementById('refInput').value = p.get('ref');
    };
</script>
</body>
</html>
