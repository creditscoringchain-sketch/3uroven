<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkPoint Short - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–õ–æ–≥–æ—Ç–∏–ø) */
        header { text-align: center; margin-bottom: 30px; padding: 30px; background: rgba(255, 255, 255, 0.05); border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); }
        h1 { color: #00ff9d; font-size: 2.8rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; }
        .sub-logo { color: #8a9ba8; font-size: 1.1rem; }

        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ (–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞) */
        #authScreen { text-align: center; padding: 50px 20px; }
        .connect-main-btn { 
            background: linear-gradient(45deg, #00ff9d, #00b8ff); 
            color: #000; border: none; padding: 18px 40px; 
            border-radius: 30px; font-weight: bold; font-size: 1.2rem;
            cursor: pointer; transition: 0.3s; width: 100%; max-width: 400px;
            box-shadow: 0 10px 20px rgba(0, 255, 157, 0.2);
        }
        .connect-main-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 25px rgba(0, 255, 157, 0.4); }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–°–ö–†–´–¢ –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ) */
        #mainAppUI { display: none; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –ø–∞–Ω–µ–ª–µ–π */
        .panel { background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 20px; }
        .tabs { display: flex; margin-bottom: 25px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .tab { padding: 12px 25px; cursor: pointer; color: #8a9ba8; }
        .tab.active { border-bottom: 3px solid #00ff9d; color: #00ff9d; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } }
        .stat-card { background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: center; }
        .stat-value { font-size: 1.5rem; color: #00ff9d; font-weight: bold; }
        
        .level-item { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .circles { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .circle { width: 20px; height: 20px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid #444; }
        .circle.active { background: #00ff9d; box-shadow: 0 0 8px #00ff9d; border: none; }

        .admin-badge { background: gold; color: #000; padding: 2px 10px; border-radius: 5px; font-size: 0.8rem; display: none; margin-left: 10px; vertical-align: middle; }
        .message { padding: 15px; border-radius: 8px; margin: 15px 0; display: none; }
        .error { background: rgba(255, 65, 108, 0.2); color: #ff416c; border: 1px solid #ff416c; }
        .success { background: rgba(0, 255, 157, 0.2); color: #00ff9d; border: 1px solid #00ff9d; }
        .form-group input { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; color: #fff; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SparkPoint Short <span id="adminBadge" class="admin-badge">ADMIN</span></h1>
            <div id="statusText" class="sub-logo">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–æ–π</div>
        </header>

        <div id="authScreen">
            <button class="connect-main-btn" id="connectBtn">
                üîó –ü–û–î–ö–õ–Æ–ß–ò–¢–¨ –ö–û–®–ï–õ–ï–ö
            </button>
        </div>

        <div id="mainAppUI">
            <div class="tabs">
                <div class="tab active" onclick="openTab('userTab', this)">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</div>
                <div class="tab" id="adminTabBtn" style="display:none;" onclick="openTab('adminTab', this)">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
            </div>

            <div id="userTab" class="tab-content active">
                <div class="dashboard">
                    <div class="panel">
                        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                        <div class="stat-card">
                            <label>–í–∞—à —É—Ä–æ–≤–µ–Ω—å</label>
                            <div class="stat-value" id="uLevel">0 / 3</div>
                        </div>
                        <div class="stat-card">
                            <label>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å</label>
                            <div class="stat-value" id="uBalance">0.00 BNB</div>
                        </div>
                        <div class="stat-card">
                            <label>–í–∞—Å –ø—Ä–∏–≥–ª–∞—Å–∏–ª</label>
                            <div id="uReferrer" style="font-size: 0.8rem; color: #00b8ff; word-break: break-all;">-</div>
                        </div>
                        <div class="stat-card">
                            <label>–†–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–ø—Ä—è–º—ã—Ö)</label>
                            <div class="stat-value" id="uDirect">0 / 2</div>
                        </div>
                        <div class="panel" style="margin-top:10px; padding:15px; background:rgba(0,184,255,0.05);">
                            <label style="font-size:0.8rem; color:#8a9ba8;">–í–∞—à–∞ —Å—Å—ã–ª–∫–∞:</label>
                            <input type="text" id="uRefLink" readonly style="width:100%; background:transparent; border:none; color:#00ff9d; font-size:0.85rem; margin-top:5px;">
                            <button onclick="copyRef()" style="width:100%; margin-top:10px; padding:8px; border-radius:8px; border:none; background:#00b8ff; color:#fff; cursor:pointer;">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                    </div>

                    <div class="panel">
                        <h2>–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω–µ–π</h2>
                        <div id="levelsList"></div>
                    </div>
                </div>

                <div class="panel" id="regSection" style="display:none;">
                    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (0.01 BNB)</h2>
                    <input type="text" id="regRefInput" placeholder="–ê–¥—Ä–µ—Å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è (0x...)">
                    <button class="connect-main-btn" onclick="actionRegister()" style="margin-top:15px;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    <div id="regMsg" class="message"></div>
                </div>
            </div>

            <div id="adminTab" class="tab-content">
                <div class="panel" style="border-color: gold;">
                    <h2 style="color:gold;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
                    <p>–ë–∞–ª–∞–Ω—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞: <span id="contractBalance" class="stat-value" style="font-size:1.1rem;">0 BNB</span></p>
                    <button onclick="actionWithdraw()" style="background:gold; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:10px;">–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞</button>
                    <hr style="margin:20px 0; opacity:0.1;">
                    <h3>–î–æ–±–∞–≤–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</h3>
                    <input type="text" id="admUserAddr" placeholder="–ê–¥—Ä–µ—Å –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞">
                    <input type="text" id="admRefAddr" placeholder="–ê–¥—Ä–µ—Å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è" style="margin-top:10px;">
                    <button onclick="actionAdminAdd()" style="margin-top:10px; width:100%; padding:10px; background:#00ff9d; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <div id="admMsg" class="message"></div>
                </div>
                <div class="panel">
                    <h2>–ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É</h2>
                    <input type="text" id="searchAddr" placeholder="0x...">
                    <button onclick="actionSearch()" style="margin-top:10px; width:100%; padding:10px; background:#333; color:#fff; border:none; border-radius:8px; cursor:pointer;">–ù–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ</button>
                    <div id="searchResult" style="margin-top:15px; display:none; background:rgba(0,0,0,0.3); padding:15px; border-radius:10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = '0x2c52760504AF1a405A225631947a8BF604fA74b9';
        const ABI = [
            {"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"adminAddUser","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"_referrer","type":"address"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserStatus","outputs":[{"internalType":"uint256","name":"currentLevel","type":"uint256"},{"internalType":"address","name":"hisReferrer","type":"address"},{"internalType":"uint256","name":"filledInCurrentLevel","type":"uint256"},{"internalType":"uint256","name":"neededForNextLevel","type":"uint256"},{"internalType":"uint256","name":"totalPersonalReferrals","type":"uint256"},{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"bool","name":"isRegistered","type":"bool"}],"stateMutability":"view","type":"function"}
        ];

        let web3, contract, userAccount;
        const THRESHOLDS = [0, 2, 6, 14];

        document.getElementById('connectBtn').onclick = connect;

        async function connect() {
            if (!window.ethereum) return alert("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ MetaMask!");
            try {
                web3 = new Web3(window.ethereum);
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º UI
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainAppUI').style.display = 'block';
                document.getElementById('statusText').innerText = "–ê–∫—Ç–∏–≤–µ–Ω: " + userAccount.substring(0,10) + "...";
                
                checkAdmin();
                loadUserData();
                
                const urlParams = new URLSearchParams(window.location.search);
                if(urlParams.has('ref')) document.getElementById('regRefInput').value = urlParams.get('ref');
            } catch (e) { console.error(e); }
        }

        async function loadUserData() {
            const data = await contract.methods.getUserStatus(userAccount).call();
            if(data.isRegistered) {
                document.getElementById('regSection').style.display = 'none';
                document.getElementById('uLevel').innerText = data.currentLevel + " / 3";
                document.getElementById('uBalance').innerText = web3.utils.fromWei(data.balance, 'ether') + " BNB";
                document.getElementById('uReferrer').innerText = data.hisReferrer;
                document.getElementById('uDirect').innerText = data.totalPersonalReferrals + " / 2";
                document.getElementById('uRefLink').value = window.location.origin + window.location.pathname + "?ref=" + userAccount;
                renderLevels(data.currentLevel, data.filledInCurrentLevel);
            } else {
                document.getElementById('regSection').style.display = 'block';
            }
        }

        function renderLevels(current, filled) {
            const container = document.getElementById('levelsList');
            container.innerHTML = '';
            for(let i=1; i<=3; i++) {
                const count = (i < current) ? THRESHOLDS[i] : (i == current ? filled : 0);
                container.innerHTML += `<div class="level-item">
                    <div style="display:flex; justify-content:space-between"><span>–£—Ä–æ–≤–µ–Ω—å ${i}</span><span>${count}/${THRESHOLDS[i]}</span></div>
                    <div class="circles">${Array.from({length: THRESHOLDS[i]}).map((_, idx) => `<div class="circle ${idx < count ? 'active' : ''}"></div>`).join('')}</div>
                </div>`;
            }
        }

        async function checkAdmin() {
            const adm = await contract.methods.admin().call();
            if(adm.toLowerCase() === userAccount.toLowerCase()) {
                document.getElementById('adminBadge').style.display = 'inline-block';
                document.getElementById('adminTabBtn').style.display = 'block';
                const bal = await web3.eth.getBalance(CONTRACT_ADDRESS);
                document.getElementById('contractBalance').innerText = web3.utils.fromWei(bal, 'ether') + " BNB";
            }
        }

        async function actionRegister() {
            const ref = document.getElementById('regRefInput').value;
            try {
                await contract.methods.register(ref).send({ from: userAccount, value: web3.utils.toWei('0.01', 'ether') });
                location.reload();
            } catch (e) { alert("–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"); }
        }

        async function actionSearch() {
            const addr = document.getElementById('searchAddr').value;
            if(!web3.utils.isAddress(addr)) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å");
            const d = await contract.methods.getUserStatus(addr).call();
            const res = document.getElementById('searchResult');
            res.style.display = 'block';
            res.innerHTML = `<p>–£—Ä–æ–≤–µ–Ω—å: ${d.currentLevel}</p><p>–†–µ—Ñ–µ—Ä–µ—Ä: ${d.hisReferrer}</p><p>–ë–∞–ª–∞–Ω—Å: ${web3.utils.fromWei(d.balance, 'ether')} BNB</p>`;
        }

        function openTab(id, el) {
            document.querySelectorAll('.tab-content, .tab').forEach(x => x.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        function copyRef() {
            const copyText = document.getElementById("uRefLink");
            copyText.select();
            document.execCommand("copy");
            alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
        }
    </script>
</body>
</html>

