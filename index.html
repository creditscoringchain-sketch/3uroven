<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkPoint Short - 3 –£—Ä–æ–≤–Ω—è</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 40px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        h1 { color: #00ff9d; font-size: 2.5rem; margin-bottom: 10px; text-shadow: 0 0 10px rgba(0, 255, 157, 0.3); }
        .subtitle { color: #8a9ba8; font-size: 1.2rem; }
        .wallet-section { background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .connect-btn { background: linear-gradient(45deg, #00ff9d, #00b8ff); color: #000; border: none; padding: 12px 30px; border-radius: 25px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .connect-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 255, 157, 0.4); }
        .wallet-info { display: none; margin-top: 15px; padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 10px; border-left: 4px solid #00ff9d; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } }
        .panel { background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .panel h2 { color: #00ff9d; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid rgba(0, 255, 157, 0.3); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 10px; text-align: center; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: #00ff9d; margin: 10px 0; }
        .stat-label { color: #8a9ba8; font-size: 0.9rem; }
        .levels-container { margin-top: 20px; }
        .level-section { margin-bottom: 30px; }
        .level-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; }
        .level-name { font-weight: bold; font-size: 1.2rem; }
        .level-required { color: #00ff9d; font-size: 0.9rem; }
        .circles-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 10px; min-height: 80px; }
        .circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: all 0.3s; font-size: 0.9rem; }
        .circle-empty { background: rgba(255, 255, 255, 0.1); border: 2px dashed rgba(255, 255, 255, 0.3); }
        .circle-filled { background: linear-gradient(45deg, #00ff9d, #00b8ff); border: 2px solid #00ff9d; box-shadow: 0 0 10px rgba(0, 255, 157, 0.5); color: #000; }
        .circle-locked { background: rgba(0, 0, 0, 0.5); border: 2px solid rgba(255, 255, 255, 0.05); color: #444; }
        .referral-link { margin-top: 25px; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; border-left: 4px solid #00b8ff; }
        .referral-link h3 { margin-bottom: 15px; color: #00b8ff; }
        .link-container { display: flex; gap: 10px; }
        .link-container input { flex: 1; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 1rem; }
        .copy-btn { background: #00b8ff; color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; transition: background 0.3s; }
        .copy-btn:hover { background: #0099d4; }
        .clear-btn { background: #8a9ba8; color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; transition: background 0.3s; }
        .clear-btn:hover { background: #6c7d8b; }
        .admin-panel { background: rgba(255, 215, 0, 0.05); border-color: rgba(255, 215, 0, 0.3); }
        .admin-panel h2 { color: #ffd700; border-bottom-color: rgba(255, 215, 0, 0.3); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #8a9ba8; }
        .form-group input { width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 1rem; }
        .form-group input:focus { outline: none; border-color: #00ff9d; }
        .admin-btn { background: linear-gradient(45deg, #ffd700, #ffaa00); color: #000; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: transform 0.3s; margin-right: 10px; margin-bottom: 10px; }
        .admin-btn:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(45deg, #00ff9d, #00b8ff); color: #000; }
        .search-section { margin-top: 30px; padding: 20px; background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        .search-results { margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; display: none; }
        .user-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .user-detail { background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; }
        .user-detail label { display: block; color: #8a9ba8; font-size: 0.9rem; margin-bottom: 5px; }
        .user-detail span { color: #00ff9d; font-weight: bold; font-size: 1.1rem; }
        .message { padding: 15px; border-radius: 8px; margin: 15px 0; display: none; }
        .success { background: rgba(0, 255, 157, 0.1); border: 1px solid rgba(0, 255, 157, 0.3); color: #00ff9d; }
        .error { background: rgba(255, 65, 108, 0.1); border: 1px solid rgba(255, 65, 108, 0.3); color: #ff416c; }
        .info { background: rgba(0, 184, 255, 0.1); border: 1px solid rgba(0, 184, 255, 0.3); color: #00b8ff; }
        .tabs { display: flex; margin-bottom: 25px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .tab { padding: 12px 25px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab:hover { background: rgba(255, 255, 255, 0.05); }
        .tab.active { border-bottom: 3px solid #00ff9d; color: #00ff9d; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loading { text-align: center; padding: 30px; color: #8a9ba8; }
        footer { text-align: center; margin-top: 40px; padding: 20px; color: #8a9ba8; font-size: 0.9rem; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .admin-badge { background: linear-gradient(45deg, #ffd700, #ffaa00); color: black; padding: 3px 10px; border-radius: 15px; font-size: 0.8rem; margin-left: 10px; font-weight: bold; display: inline-block; }
        .ref-info { margin-top: 10px; padding: 10px; background: rgba(0, 184, 255, 0.1); border-radius: 5px; font-size: 0.9rem; color: #00b8ff; }
        .referrer-check { margin-top: 10px; font-size: 0.9rem; padding: 8px; border-radius: 5px; }
        .referrer-valid { background: rgba(0, 255, 157, 0.1); color: #00ff9d; border: 1px solid rgba(0, 255, 157, 0.3); }
        .referrer-invalid { background: rgba(255, 65, 108, 0.1); color: #ff416c; border: 1px solid rgba(255, 65, 108, 0.3); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SparkPoint <span id="adminBadge" class="admin-badge" style="display:none;">–ê–î–ú–ò–ù</span></h1>
            <div class="subtitle">Short Version: 3 –£—Ä–æ–≤–Ω—è</div>
        </header>
        
        <div class="wallet-section">
            <button class="connect-btn" id="connectWallet">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
            <div class="wallet-info" id="walletInfo">
                <div>–ê–¥—Ä–µ—Å: <span id="walletAddress"></span></div>
                <div>–ë–∞–ª–∞–Ω—Å BNB/ETH: <span id="walletBalance"></span></div>
                <div>–°—Ç–∞—Ç—É—Å: <span id="userStatus">–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</span></div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="user">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</div>
            <div class="tab" data-tab="admin" style="display:none;">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</div>
        </div>
        
        <div class="tab-content active" id="userTab">
            <div class="dashboard">
                <div class="panel">
                    <h2>–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <div class="stats-grid" id="userStats"></div>
                    <div class="referral-link">
                        <h3>–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</h3>
                        <div class="link-container">
                            <input type="text" id="referralLink" readonly value="–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫">
                            <button class="copy-btn" onclick="copyReferralLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                        <div id="referrerCheckResult" class="referrer-check" style="display: none;"></div>
                        <div id="currentRefInfo" class="ref-info" style="display: none;">
                            –ü–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é: <span id="currentRefAddress"></span>
                            <button class="clear-btn" onclick="clearReferralParam()" style="margin-left: 10px; padding: 2px 8px; font-size: 0.8rem;">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <h2>–ú–æ–∏ —É—Ä–æ–≤–Ω–∏ (–í—Å–µ–≥–æ 3)</h2>
                    <div class="levels-container" id="levelsContainer"></div>
                </div>
            </div>
            
            <div class="panel">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <div class="form-group">
                    <label for="referrerAddress">–ê–¥—Ä–µ—Å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è:</label>
                    <input type="text" id="referrerAddress" placeholder="0x..." value="" oninput="checkReferrerExists()">
                    <div id="referrerStatus" style="margin-top: 5px; font-size: 0.9rem;"></div>
                </div>
                <div style="margin: 20px 0; padding: 15px; background: rgba(0, 184, 255, 0.1); border-radius: 8px; color: #00b8ff;">
                    <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> 0.01 BNB (–∏–ª–∏ ETH)
                </div>
                <button class="connect-btn btn-primary" id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–∞ 0.01 BNB</button>
                <div class="message" id="registerMessage"></div>
            </div>
        </div>
        
        <div class="tab-content" id="adminTab">
            <div class="panel admin-panel">
                <h2>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
                <div class="stats-grid" id="adminStats"></div>
                <div class="form-group">
                    <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)</h3>
                    <label for="newUserAddress">–ê–¥—Ä–µ—Å –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞:</label>
                    <input type="text" id="newUserAddress" placeholder="0x...">
                    <label for="newUserReferrer" style="margin-top: 15px;">–ê–¥—Ä–µ—Å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è:</label>
                    <input type="text" id="newUserReferrer" placeholder="0x...">
                    <button class="admin-btn btn-primary" id="addUserBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <div class="message" id="addUserMessage"></div>
                </div>
                <div class="form-group">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                    <button class="admin-btn btn-primary" id="withdrawBtn">–í—ã–≤–µ—Å—Ç–∏ –≤–µ—Å—å –±–∞–ª–∞–Ω—Å</button>
                    <div class="message" id="withdrawMessage"></div>
                </div>
                <div class="search-section">
                    <h3>–ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É</h3>
                    <input type="text" id="searchAddress" placeholder="0x..." style="width:100%; padding:10px; margin-bottom:10px; border-radius:5px; background: rgba(255,255,255,0.1); color:white; border:1px solid #555;">
                    <button class="admin-btn" id="searchBtn">–ù–∞–π—Ç–∏</button>
                    <div class="search-results" id="searchResults">
                        <div class="user-details" id="userDetails"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="message" id="globalMessage"></div>
        
        <footer>
            –ö–æ–Ω—Ç—Ä–∞–∫—Ç: <a href="#" id="contractLink" target="_blank" style="color: #00b8ff;">0x...</a> | SparkPoint Short
        </footer>
    </div>

    <script>
        // ==============================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ö–û–ù–¢–†–ê–ö–¢–ê
        // ==============================
        const CONTRACT_ADDRESS = '0x2c52760504AF1a405A225631947a8BF604fA74b9';
        
        // ABI –¢–û–ß–ù–û –°–û–û–¢–í–ï–¢–°–¢–í–£–Æ–©–ò–ô SparkPointShort
        const CONTRACT_ABI = [
            {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"InternalCredit","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"level","type":"uint256"}],"name":"LevelUp","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"level","type":"uint256"}],"name":"Payout","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"referrer","type":"address"}],"name":"Registered","type":"event"},
            {"inputs":[],"name":"ENTRY_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"adminAddUser","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserStatus","outputs":[{"internalType":"uint256","name":"currentLevel","type":"uint256"},{"internalType":"address","name":"hisReferrer","type":"address"},{"internalType":"uint256","name":"filledInCurrentLevel","type":"uint256"},{"internalType":"uint256","name":"neededForNextLevel","type":"uint256"},{"internalType":"uint256","name":"totalPersonalReferrals","type":"uint256"},{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"bool","name":"isRegistered","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"_referrer","type":"address"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"thresholds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"level","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"referralsInLevel","type":"uint256"},{"internalType":"uint256","name":"totalDirectReferrals","type":"uint256"},{"internalType":"uint256","name":"internalBalance","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"stateMutability":"payable","type":"receive"}
        ];
        
        // –ü–æ—Ä–æ–≥–∏ –¥–ª—è 3-—Ö —É—Ä–æ–≤–Ω–µ–π
        const LEVEL_THRESHOLDS = {
            1: 2,
            2: 6,
            3: 14
        };
        const ENTRY_PRICE_WEI = '10000000000000000'; // 0.01 ETH
        
        let web3;
        let contract;
        let userAccount;
        let isAdmin = false;
        
        // ==============================
        // DOM ELEMENTS
        // ==============================
        const elements = {
            connectWalletBtn: document.getElementById('connectWallet'),
            walletInfo: document.getElementById('walletInfo'),
            walletAddress: document.getElementById('walletAddress'),
            walletBalance: document.getElementById('walletBalance'),
            userStatus: document.getElementById('userStatus'),
            adminBadge: document.getElementById('adminBadge'),
            userStats: document.getElementById('userStats'),
            levelsContainer: document.getElementById('levelsContainer'),
            referralLink: document.getElementById('referralLink'),
            referrerAddressInput: document.getElementById('referrerAddress'),
            referrerStatus: document.getElementById('referrerStatus'),
            registerBtn: document.getElementById('registerBtn'),
            adminStats: document.getElementById('adminStats'),
            referrerCheckResult: document.getElementById('referrerCheckResult'),
            currentRefInfo: document.getElementById('currentRefInfo'),
            currentRefAddress: document.getElementById('currentRefAddress'),
            globalMessage: document.getElementById('globalMessage'),
            contractLink: document.getElementById('contractLink')
        };
        
        elements.contractLink.href = `https://testnet.bscscan.com/address/${CONTRACT_ADDRESS}`; // –ò–ª–∏ etherscan
        elements.contractLink.textContent = `${CONTRACT_ADDRESS.substring(0,6)}...${CONTRACT_ADDRESS.substring(38)}`;

        // ==============================
        // INITIALIZATION
        // ==============================
        window.addEventListener('load', async () => {
            handleUrlParams();
            
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–∫–ª—é—á–µ–Ω –ª–∏ —É–∂–µ
                const accounts = await web3.eth.getAccounts();
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } else {
                elements.connectWalletBtn.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ MetaMask';
                elements.connectWalletBtn.disabled = true;
            }
            
            // Event Listeners
            elements.connectWalletBtn.addEventListener('click', connectWallet);
            elements.registerBtn.addEventListener('click', registerUser);
            document.getElementById('addUserBtn').addEventListener('click', addUserByAdmin);
            document.getElementById('withdrawBtn').addEventListener('click', withdrawAdmin);
            document.getElementById('searchBtn').addEventListener('click', searchUser);
            
            elements.referrerAddressInput.addEventListener('input', checkReferrerExists);
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    if (tab.dataset.tab === 'admin' && !isAdmin) return;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}Tab`).classList.add('active');
                });
            });
        });

        // ==============================
        // CORE FUNCTIONS
        // ==============================
        async function connectWallet() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                
                elements.walletAddress.textContent = shortenAddress(userAccount);
                elements.connectWalletBtn.textContent = '–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω';
                elements.walletInfo.style.display = 'block';
                
                const balance = await web3.eth.getBalance(userAccount);
                elements.walletBalance.textContent = parseFloat(web3.utils.fromWei(balance, 'ether')).toFixed(4) + ' BNB';
                
                await checkAdmin();
                await updateUI();
                
                if (elements.referrerAddressInput.value) checkReferrerExists();
                
                window.ethereum.on('accountsChanged', () => window.location.reload());
                
            } catch (error) {
                console.error(error);
                showMessage(error.message, 'error');
            }
        }
        
        async function checkAdmin() {
            try {
                const adminAddr = await contract.methods.admin().call();
                isAdmin = (userAccount.toLowerCase() === adminAddr.toLowerCase());
                
                if (isAdmin) {
                    elements.adminBadge.style.display = 'inline-block';
                    elements.userStatus.textContent = '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
                    document.querySelector('.tab[data-tab="admin"]').style.display = 'block';
                    loadAdminStats();
                } else {
                    elements.userStatus.textContent = '–£—á–∞—Å—Ç–Ω–∏–∫';
                }
            } catch (e) { console.error(e); }
        }
        
        async function updateUI() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é getUserStatus –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å—Ä–∞–∑—É
                // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {0: level, 1: referrer, 2: filledInLevel, 3: needed, 4: totalRefs, 5: balance, 6: registered}
                const data = await contract.methods.getUserStatus(userAccount).call();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–µ—Ñ —Å—Å—ã–ª–∫—É
                const currentUrl = window.location.href.split('?')[0];
                elements.referralLink.value = `${currentUrl}?ref=${userAccount}`;

                if (!data.isRegistered) {
                    elements.userStats.innerHTML = `<div class="stat-card"><div class="stat-value">–ù–µ—Ç</div><div class="stat-label">–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã</div></div>`;
                    elements.levelsContainer.innerHTML = '<div class="loading">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —É—Ä–æ–≤–Ω–∏</div>';
                    return;
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                elements.userStats.innerHTML = `
                    <div class="stat-card"><div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div><div class="stat-value">${data.currentLevel}</div></div>
                    <div class="stat-card"><div class="stat-label">–ë–∞–ª–∞–Ω—Å (Credit)</div><div class="stat-value">${web3.utils.fromWei(data.balance, 'ether')} ETH</div></div>
                    <div class="stat-card"><div class="stat-label">–õ–∏—á–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</div><div class="stat-value">${data.totalPersonalReferrals}/2</div></div>
                    <div class="stat-card"><div class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω—è</div><div class="stat-value">${data.filledInCurrentLevel} / ${data.neededForNextLevel}</div></div>
                `;

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—Ä—É–∂–∫–æ–≤ —É—Ä–æ–≤–Ω–µ–π
                renderLevels(parseInt(data.currentLevel), parseInt(data.filledInCurrentLevel));

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
            }
        }

        function renderLevels(userLevel, filledInCurrent) {
            let html = '';
            
            // –í—Å–µ–≥–æ 3 —É—Ä–æ–≤–Ω—è
            for (let lvl = 1; lvl <= 3; lvl++) {
                const max = LEVEL_THRESHOLDS[lvl];
                let filledCount = 0;
                let isLocked = false;
                let isCompleted = false;

                if (lvl < userLevel) {
                    // –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é
                    filledCount = max;
                    isCompleted = true;
                } else if (lvl === userLevel) {
                    // –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å
                    filledCount = filledInCurrent;
                } else {
                    // –ë—É–¥—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å
                    isLocked = true;
                }

                let circles = '';
                for (let i = 0; i < max; i++) {
                    let className = 'circle-empty';
                    let content = i + 1;
                    
                    if (isLocked) {
                        className = 'circle-locked';
                        content = 'üîí';
                    } else if (i < filledCount) {
                        className = 'circle-filled';
                        content = '‚úì';
                    }
                    
                    circles += `<div class="circle ${className}">${content}</div>`;
                }

                html += `
                    <div class="level-section">
                        <div class="level-title" style="${isLocked ? 'opacity:0.5' : ''}">
                            <div class="level-name">–£—Ä–æ–≤–µ–Ω—å ${lvl} ${isCompleted ? '(–ó–∞–≤–µ—Ä—à–µ–Ω)' : ''}</div>
                            <div class="level-required">–ù—É–∂–Ω–æ: ${max} —á–µ–ª.</div>
                        </div>
                        <div class="circles-container">${circles}</div>
                    </div>
                `;
            }
            elements.levelsContainer.innerHTML = html;
        }

        async function registerUser() {
            if (!userAccount) return showMessage('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫', 'error');
            
            const refAddr = elements.referrerAddressInput.value.trim();
            if (!web3.utils.isAddress(refAddr)) return showMessage('–ù–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è', 'error');
            
            try {
                // 0.01 ETH
                await contract.methods.register(refAddr).send({
                    from: userAccount,
                    value: ENTRY_PRICE_WEI
                });
                showMessage('–£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!', 'success');
                setTimeout(updateUI, 2000);
            } catch (e) {
                showMessage('–û—à–∏–±–∫–∞: ' + (e.message || e), 'error');
            }
        }

        // ==============================
        // ADMIN FUNCTIONS
        // ==============================
        async function loadAdminStats() {
            const balance = await web3.eth.getBalance(CONTRACT_ADDRESS);
            document.getElementById('adminStats').innerHTML = `
                <div class="stat-card" style="border:1px solid gold;">
                    <div class="stat-label">–ë–∞–ª–∞–Ω—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</div>
                    <div class="stat-value">${web3.utils.fromWei(balance, 'ether')} BNB</div>
                </div>
            `;
        }

        async function addUserByAdmin() {
            const u = document.getElementById('newUserAddress').value;
            const r = document.getElementById('newUserReferrer').value;
            try {
                await contract.methods.adminAddUser(u, r).send({from: userAccount});
                showMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            } catch(e) { showMessage(e.message, 'error'); }
        }

        async function withdrawAdmin() {
            try {
                await contract.methods.withdraw().send({from: userAccount});
                showMessage('–°—Ä–µ–¥—Å—Ç–≤–∞ –≤—ã–≤–µ–¥–µ–Ω—ã', 'success');
                loadAdminStats();
            } catch(e) { showMessage(e.message, 'error'); }
        }

        async function searchUser() {
            const addr = document.getElementById('searchAddress').value;
            const resDiv = document.getElementById('userDetails');
            try {
                const d = await contract.methods.getUserStatus(addr).call();
                document.getElementById('searchResults').style.display = 'block';
                if (!d.isRegistered) {
                    resDiv.innerHTML = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
                } else {
                    resDiv.innerHTML = `
                        <div class="user-detail"><label>–£—Ä–æ–≤–µ–Ω—å</label><span>${d.currentLevel}</span></div>
                        <div class="user-detail"><label>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å</label><span>${shortenAddress(d.hisReferrer)}</span></div>
                        <div class="user-detail"><label>–ë–∞–ª–∞–Ω—Å</label><span>${web3.utils.fromWei(d.balance, 'ether')}</span></div>
                    `;
                }
            } catch(e) { console.error(e); }
        }

        // ==============================
        // UTILS & REFERRAL LOGIC
        // ==============================
        function handleUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const ref = params.get('ref');
            if (ref && web3.utils.isAddress(ref)) {
                localStorage.setItem('sp_ref', ref);
                applyRef(ref);
            } else if (localStorage.getItem('sp_ref')) {
                applyRef(localStorage.getItem('sp_ref'));
            }
        }
        
        function applyRef(addr) {
            elements.currentRefAddress.textContent = shortenAddress(addr);
            elements.currentRefInfo.style.display = 'block';
            elements.referrerAddressInput.value = addr;
        }

        function clearReferralParam() {
            localStorage.removeItem('sp_ref');
            window.history.replaceState({}, document.title, window.location.href.split('?')[0]);
            elements.currentRefInfo.style.display = 'none';
            elements.referrerAddressInput.value = '';
        }

        async function checkReferrerExists() {
            const addr = elements.referrerAddressInput.value;
            if (!web3.utils.isAddress(addr)) return;
            
            try {
                // Check simple existence via public mapping
                const u = await contract.methods.users(addr).call();
                const statusDiv = elements.referrerStatus;
                
                if (u.exists) {
                    if (u.totalDirectReferrals >= 2) {
                        statusDiv.innerHTML = '<span style="color:orange">–í–Ω–∏–º–∞–Ω–∏–µ: –£ —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞ —É–∂–µ 2 —Ä–µ—Ñ–µ—Ä–∞–ª–∞ (–ª–∏–º–∏—Ç)</span>';
                    } else {
                        statusDiv.innerHTML = '<span style="color:#00ff9d">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å –≤–∞–ª–∏–¥–µ–Ω</span>';
                    }
                } else {
                    statusDiv.innerHTML = '<span style="color:red">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ</span>';
                }
            } catch(e) {}
        }

        function shortenAddress(a) { return a ? a.substring(0,6) + '...' + a.substring(38) : ''; }
        function showMessage(msg, type) {
            const el = elements.globalMessage;
            el.textContent = msg;
            el.className = `message ${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }
        function copyReferralLink() {
            navigator.clipboard.writeText(elements.referralLink.value);
            showMessage('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', 'success');
        }
    </script>
</body>
</html>
