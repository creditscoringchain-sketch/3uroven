<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .block { background: #2a2a2a; border-radius: 10px; padding: 20px; margin: 10px auto; max-width: 500px; border: 1px solid #444; }
        .btn { background: #00ff88; color: black; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .circle { width: 15px; height: 15px; border-radius: 50%; background: #444; display: inline-block; margin: 2px; }
        .active { background: #00ff88; box-shadow: 0 0 5px #00ff88; }
        input { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; background: #333; color: white; border: 1px solid #555; }
        .stat { display: flex; justify-content: space-between; margin: 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
    </style>
</head>
<body>

    <h1>SparkPoint 3 Levels</h1>
    <div id="addr">Кошелек не подключен</div>
    <button id="connectBtn" class="btn" onclick="connect()">Подключить кошелек</button>

    <div id="mainUI" style="display:none;">
        <div class="block">
            <h3>Личный кабинет</h3>
            <div class="stat"><span>Ваш уровень:</span> <b id="uLevel">-</b></div>
            <div class="stat"><span>Баланс:</span> <b id="uBalance">-</b></div>
            <div class="stat"><span>Вас пригласил:</span> <b id="uReferrer" style="font-size:10px;">-</b></div>
            <div class="stat"><span>Личных рефералов:</span> <b id="uDirect">-</b></div>
            
            <p style="font-size:12px; margin-top:10px;">Ваша ссылка:</p>
            <input type="text" id="uLink" readonly onclick="this.select(); document.execCommand('copy');">
        </div>

        <div id="regBlock" class="block" style="display:none;">
            <h3>Регистрация (0.01 BNB)</h3>
            <input type="text" id="refInput" placeholder="Адрес пригласителя">
            <button class="btn" onclick="register()">Вступить</button>
        </div>

        <div class="block">
            <h3>Прогресс (2, 6, 14 человек)</h3>
            <div id="lvls"></div>
        </div>

        <div id="adminBlock" class="block" style="display:none; border-color: gold;">
            <h3 style="color:gold;">Админ-панель</h3>
            <button class="btn" style="background:gold;" onclick="withdraw()">Вывести всё</button>
            <hr>
            <p>Добавить бесплатно:</p>
            <input type="text" id="admUser" placeholder="Адрес игрока">
            <input type="text" id="admRef" placeholder="Адрес пригласителя">
            <button class="btn" onclick="adminAdd()">Добавить</button>
        </div>
    </div>

<script>
    const ABI = [{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"adminAddUser","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_referrer","type":"address"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserStatus","outputs":[{"internalType":"uint256","name":"currentLevel","type":"uint256"},{"internalType":"address","name":"hisReferrer","type":"address"},{"internalType":"uint256","name":"filledInCurrentLevel","type":"uint256"},{"internalType":"uint256","name":"neededForNextLevel","type":"uint256"},{"internalType":"uint256","name":"totalPersonalReferrals","type":"uint256"},{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"bool","name":"isRegistered","type":"bool"}],"stateMutability":"view","type":"function"}];
    const ADDR = "0x2c52760504AF1a405A225631947a8BF604fA74b9";
    let web3, contract, user;
    const LIMITS = [0, 2, 6, 14]; // Твои 3 уровня

    async function connect() {
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            let accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            user = accounts[0];
            contract = new web3.eth.Contract(ABI, ADDR);
            
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('mainUI').style.display = 'block';
            document.getElementById('addr').innerText = user;

            // Подхват рефа из ссылки
            const params = new URLSearchParams(window.location.search);
            if(params.has('ref')) document.getElementById('refInput').value = params.get('ref');

            loadData();
        }
    }

    async function loadData() {
        const status = await contract.methods.getUserStatus(user).call();
        const admAddr = await contract.methods.admin().call();

        if (status.isRegistered) {
            document.getElementById('uLevel').innerText = status.currentLevel;
            document.getElementById('uBalance').innerText = web3.utils.fromWei(status.balance, 'ether') + " BNB";
            document.getElementById('uReferrer').innerText = status.hisReferrer;
            document.getElementById('uDirect').innerText = status.totalPersonalReferrals;
            document.getElementById('uLink').value = window.location.origin + window.location.pathname + "?ref=" + user;
            
            // Круги
            let html = "";
            for(let i=1; i<=3; i++) {
                let count = (i < status.currentLevel) ? LIMITS[i] : (i == status.currentLevel ? status.filledInCurrentLevel : 0);
                html += `<div>Уровень ${i} (${count}/${LIMITS[i]})<br>`;
                for(let j=0; j<LIMITS[i]; j++) html += `<div class="circle ${j<count?'active':''}"></div>`;
                html += `</div><br>`;
            }
            document.getElementById('lvls').innerHTML = html;
        } else {
            document.getElementById('regBlock').style.display = 'block';
        }

        if(user.toLowerCase() === admAddr.toLowerCase()) document.getElementById('adminBlock').style.display = 'block';
    }

    async function register() {
        let ref = document.getElementById('refInput').value || "0x0000000000000000000000000000000000000000";
        await contract.methods.register(ref).send({ from: user, value: web3.utils.toWei('0.01', 'ether') });
        location.reload();
    }

    async function withdraw() { await contract.methods.withdraw().send({ from: user }); }
    
    async function adminAdd() {
        let u = document.getElementById('admUser').value;
        let r = document.getElementById('admRef').value;
        await contract.methods.adminAddUser(u, r).send({ from: user });
        alert("Добавлен!");
    }
</script>
</body>
</html>
