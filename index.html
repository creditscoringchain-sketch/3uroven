<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkPoint - Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        :root { --primary: #00ff9d; --secondary: #00b8ff; --admin: #ffd700; --bg: #1a1a2e; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        
        /* Кнопки */
        .btn { padding: 12px 25px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-connect { background: var(--primary); color: #000; }
        .btn-reg { background: var(--secondary); color: #fff; width: 100%; font-size: 1.1rem; }
        .btn-admin { background: var(--admin); color: #000; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #000; color: #fff; box-sizing: border-box; }
        
        #adminSection { border: 2px solid var(--admin); display: none; }
        #dashboardSection { display: none; }
        #registrationSection { display: block; } /* По умолчанию виден */
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; text-align: center; }
        .label { color: #888; font-size: 0.8rem; }
        .value { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2>SparkPoint</h2>
        <button id="connectBtn" class="btn btn-connect" onclick="connect()">Подключить кошелек</button>
        <div id="walletAddr" style="display:none; color:var(--primary)"></div>
    </div>

    <div id="adminSection" class="card">
        <h3 style="color:var(--admin)">АДМИН-ПАНЕЛЬ</h3>
        <p>Баланс контракта: <span id="contractBal" style="color:var(--admin)">0 BNB</span></p>
        <button class="btn btn-admin" onclick="withdraw()">ВЫВЕСТИ ВСЕ</button>
        <hr style="margin:15px 0; opacity:0.2;">
        <input type="text" id="admUser" placeholder="Адрес нового юзера">
        <input type="text" id="admRef" placeholder="Адрес пригласителя">
        <button class="btn btn-admin" onclick="adminAdd()">ДОБАВИТЬ БЕСПЛАТНО</button>
    </div>

    <div class="stat-grid">
        <div class="stat-box"><div class="label">Уровень</div><div id="uLevel" class="value">-</div></div>
        <div class="stat-box"><div class="label">Баланс (BNB)</div><div id="uBalance" class="value">0</div></div>
    </div>

    <div id="registrationSection" class="card">
        <h3>Регистрация</h3>
        <p style="font-size:0.9rem; color:#888;">Цена входа: 0.01 BNB</p>
        <input type="text" id="refInput" placeholder="Адрес пригласителя (0x...)">
        <button class="btn btn-reg" onclick="register()">ОПЛАТИТЬ 0.01 BNB</button>
    </div>

    <div id="dashboardSection" class="card">
        <h3>Ваша ссылка</h3>
        <input type="text" id="refLink" readonly onclick="this.select(); document.execCommand('copy'); alert('Скопировано')">
        <p style="color:var(--primary); margin-top:10px;">✓ Вы уже зарегистрированы</p>
    </div>
</div>

<script>
    const ADDR = '0x2c52760504AF1a405A225631947a8BF604fA74b9';
    const ABI = [
        {"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"adminAddUser","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserStatus","outputs":[{"internalType":"uint256","name":"currentLevel","type":"uint256"},{"internalType":"address","name":"hisReferrer","type":"address"},{"internalType":"uint256","name":"filledInCurrentLevel","type":"uint256"},{"internalType":"uint256","name":"neededForNextLevel","type":"uint256"},{"internalType":"uint256","name":"totalPersonalReferrals","type":"uint256"},{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"bool","name":"isRegistered","type":"bool"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"_referrer","type":"address"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"}
    ];

    let web3, contract, account;

    async function connect() {
        if (!window.ethereum) return alert("Нужен MetaMask");
        web3 = new Web3(window.ethereum);
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        account = accounts[0];
        contract = new web3.eth.Contract(ABI, ADDR);

        document.getElementById('connectBtn').style.display = 'none';
        document.getElementById('walletAddr').innerText = account.slice(0,6)+'...'+account.slice(-4);
        document.getElementById('walletAddr').style.display = 'block';

        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('ref')) document.getElementById('refInput').value = urlParams.get('ref');

        loadData();
    }

    async function loadData() {
        const data = await contract.methods.getUserStatus(account).call();
        const isAdmin = (account.toLowerCase() === (await contract.methods.admin().call()).toLowerCase());

        if (isAdmin) {
            document.getElementById('adminSection').style.display = 'block';
            const b = await web3.eth.getBalance(ADDR);
            document.getElementById('contractBal').innerText = web3.utils.fromWei(b, 'ether') + ' BNB';
        }

        if (data.isRegistered) {
            document.getElementById('registrationSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('uLevel').innerText = data.currentLevel;
            document.getElementById('uBalance').innerText = web3.utils.fromWei(data.balance, 'ether');
            document.getElementById('refLink').value = window.location.origin + window.location.pathname + "?ref=" + account;
        }
    }

    async function register() {
        const ref = document.getElementById('refInput').value;
        if(!web3.utils.isAddress(ref)) return alert("Укажите адрес пригласителя");
        try {
            await contract.methods.register(ref).send({ from: account, value: web3.utils.toWei('0.01', 'ether') });
            location.reload();
        } catch(e) { alert("Ошибка: " + e.message); }
    }

    async function adminAdd() {
        const u = document.getElementById('admUser').value;
        const r = document.getElementById('admRef').value;
        try {
            await contract.methods.adminAddUser(u, r).send({ from: account });
            alert("Готово");
            loadData();
        } catch(e) { alert(e.message); }
    }

    async function withdraw() {
        try {
            await contract.methods.withdraw().send({ from: account });
            alert("Выведено");
            loadData();
        } catch(e) { alert(e.message); }
    }
</script>
</body>
</html>
